local flying = false
local speed = 50
local player = game.Players.LocalPlayer
local camera = workspace.CurrentCamera
local character = player.Character
local bodyVelocity
local UserInputService = game:GetService("UserInputService")
local uiCreated = false
local draggableFrame

-- Function to start Fly Mode
local function startFly()
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end

    flying = true

    -- Set up BodyVelocity to move the character freely
    bodyVelocity = Instance.new("BodyVelocity", character.HumanoidRootPart)
    bodyVelocity.MaxForce = Vector3.new(9e4, 9e4, 9e4)
    bodyVelocity.Velocity = Vector3.zero

    -- Loop for Fly movement
    game:GetService("RunService").RenderStepped:Connect(function()
        if not flying then return end

        local moveDirection = Vector3.zero

        -- Detect movement key presses
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
            moveDirection = moveDirection + camera.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
            moveDirection = moveDirection - camera.CFrame.LookVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
            moveDirection = moveDirection - camera.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
            moveDirection = moveDirection + camera.CFrame.RightVector
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            moveDirection = moveDirection + Vector3.new(0, 1, 0)
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            moveDirection = moveDirection - Vector3.new(0, 1, 0)
        end

        -- Apply movement
        if moveDirection ~= Vector3.zero then
            bodyVelocity.Velocity = moveDirection.Unit * speed
        else
            bodyVelocity.Velocity = Vector3.zero
        end

        -- Update CFrame to move the character
        character.HumanoidRootPart.CFrame = CFrame.new(character.HumanoidRootPart.Position + bodyVelocity.Velocity)
    end)
end

local function stopFly()
    if bodyVelocity then
        bodyVelocity:Destroy()
    end
    flying = false
end

if uiCreated then return end  -- Prevent recreating the UI

        -- Create the draggable UI window
        draggableFrame = Instance.new("Frame")
        draggableFrame.Size = UDim2.new(0, 250, 0, 300)
        draggableFrame.Position = UDim2.new(0.5, -125, 0.5, -150)
        draggableFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        draggableFrame.Parent = game.Players.LocalPlayer.PlayerGui

        -- Make the frame draggable
        local dragging = false
        local dragStartPos
        local dragStart

        draggableFrame.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStartPos = draggableFrame.Position
                dragStart = input.Position
            end
        end)

        draggableFrame.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                draggableFrame.Position = UDim2.new(dragStartPos.X.Scale, delta.X, dragStartPos.Y.Scale, delta.Y)
            end
        end)

        draggableFrame.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)

        -- Fly Toggle Button
        local flyButton = Instance.new("TextButton")
        flyButton.Size = UDim2.new(0, 100, 0, 50)
        flyButton.Position = UDim2.new(0, 25, 0, 50)
        flyButton.Text = "Fly"
        flyButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        flyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        flyButton.Parent = draggableFrame

        flyButton.MouseButton1Click:Connect(function()
            if flying then
                stopFly()
                flyButton.Text = "Fly"
                flyButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
            else
                startFly()
                flyButton.Text = "Stop"
                flyButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            end
        end)

        -- Speed Slider (Speed Changer)
        local speedSlider = Instance.new("TextButton")
        speedSlider.Size = UDim2.new(0, 200, 0, 30)
        speedSlider.Position = UDim2.new(0, 25, 0, 120)
        speedSlider.Text = "Speed: 50"
        speedSlider.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        speedSlider.TextColor3 = Color3.fromRGB(255, 255, 255)
        speedSlider.Parent = draggableFrame

        speedSlider.MouseButton1Click:Connect(function()
            local inputBox = Instance.new("TextBox")
            inputBox.Size = UDim2.new(0, 50, 0, 25)
            inputBox.Position = UDim2.new(0, 25, 0, 160)
            inputBox.Text = tostring(speed)
            inputBox.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            inputBox.Parent = draggableFrame

            inputBox.FocusLost:Connect(function()
                local newSpeed = tonumber(inputBox.Text)
                if newSpeed then
                    speed = newSpeed
                    speedSlider.Text = "Speed: " .. speed
                end
                inputBox:Destroy()
            end)

            inputBox:CaptureFocus()
        end)

        -- Kill Button (Removes UI)
        local killButton = Instance.new("TextButton")
        killButton.Size = UDim2.new(0, 100, 0, 50)
        killButton.Position = UDim2.new(0, 25, 0, 200)
        killButton.Text = "Kill UI"
        killButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        killButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        killButton.Parent = draggableFrame

        killButton.MouseButton1Click:Connect(function()
            draggableFrame:Destroy()
            uiCreated = false
        end)

        -- Credits Label
        local creditsLabel = Instance.new("TextLabel")
        creditsLabel.Size = UDim2.new(0, 200, 0, 30)
        creditsLabel.Position = UDim2.new(0, 25, 0, 250)
        creditsLabel.Text = "UI Credits to Trxth on Discord"
        creditsLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        creditsLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        creditsLabel.TextSize = 14
        creditsLabel.TextScaled = true
        creditsLabel.Parent = draggableFrame

        uiCreated = true
    end
})
